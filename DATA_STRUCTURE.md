# Data Structure Rules

**Last Updated:** November 2025

This document defines the data file structure, ID allocation, and data generation workflows for Terraria Loadout Maker.

## File Naming Convention

All data files MUST follow this pattern:

```
{category}-{mod}[-suffix].json
```

### Examples:

-   `items-vanilla.json` - Vanilla Terraria items (curated)
-   `items-calamity-scraped.json` - Calamity Mod items (wiki scraped)
-   `items-thorium-accessories-js-puppeteer.json` - Thorium accessories (Puppeteer scraped)
-   `bosses-vanilla.json` - Vanilla Terraria bosses
-   `buffs-calamity-js-puppeteer.json` - Calamity buffs/potions
-   `ammunition-thorium-scraped.json` - Thorium ammunition

### Suffixes:

-   `-scraped` - Generated by Cheerio-based wiki scrapers (static HTML)
-   `-js-puppeteer` - Generated by Puppeteer (JavaScript-rendered content)
-   No suffix - Manually curated or finalized data

## ID System

### Non-Overlapping ID Ranges

IDs MUST be unique across all mods AND all item types within a mod to prevent conflicts.

**Mod-Specific ID Ranges:**

-   **Vanilla:** 1 - 99,999
-   **Calamity:** 100,000 - 199,999
-   **Thorium:** 200,000 - 299,999

**Important Notes:**

1. **IDs are unique per mod, not per category:** All data types (items, ammo, accessories, potions) within a mod share the same ID pool to prevent conflicts
2. **Continuous ID allocation:** When scraping, IDs are assigned sequentially across all categories to avoid conflicts
3. **Example ID allocation for Calamity:**
    - Items (weapons + armor): 100,000-100,839 (840 items)
    - Ammo: 100,840-100,858 (19 ammo, continues from items)
    - Accessories: 100,859-101,075 (217 accessories, continues from ammo)
    - Potions: 101,076-101,093 (18 potions, continues from accessories)
    - Bosses: 100,000-100,025 (26 bosses, separate category - overlaps with items)

**Why bosses can overlap:** Bosses are stored separately and never mixed with items/potions/accessories in queries. They use a separate ID space since they're fundamentally different entities. However, if you plan to create a unified "entity" system in the future, consider reserving separate ID sub-ranges for bosses.

### Examples:

```json
// items-vanilla.json - First item
{"id": 1, "name": "Copper Shortsword", "mod": "vanilla"}

// ammo-vanilla.json - Continues from items
{"id": 488, "name": "Wooden Arrow", "mod": "vanilla"}

// bosses-vanilla.json - Separate category
{"id": 1, "name": "King Slime", "mod": "vanilla"}

// items-calamity.json - Different mod, resets to mod's base
{"id": 100000, "name": "Abyss Blade", "mod": "calamity"}

// items-thorium.json - Different mod
{"id": 200000, "name": "Mjolnir", "mod": "thorium"}
```

## Data Categories

### 1. Items (Weapons & Armor)

**Files:** `items-{mod}[-scraped].json`

**Required Fields:**

-   `id` (number) - Unique ID following range rules
-   `name` (string) - Item display name
-   `mod` (string) - "vanilla" | "calamity" | "thorium"
-   `type` (string) - "weapon" | "armor"
-   `rarity` (number) - 0-11 (item color tier)

**Optional Fields:**

-   `damage` (number) - For weapons only
-   `defense` (number) - For armor only
-   `weaponClass` (string) - "melee" | "ranged" | "magic" | "summoner" | "rogue" | "healer" | "symphonic"
-   `armorType` (string) - "helmet" | "chestplate" | "leggings"

**Note:** Accessories are now stored separately (see below)

### 2. Accessories

**Files:** `items-{mod}-accessories-js-puppeteer.json`

**Why Separate:** Accessories require JavaScript rendering to extract from collapsed wiki tables.

**Required Fields:**

-   `id` (number) - Unique ID following range rules
-   `name` (string) - Accessory display name
-   `mod` (string) - "vanilla" | "calamity" | "thorium"
-   `type` (string) - "accessory"
-   `rarity` (number) - Item rarity tier

### 3. Bosses

**Files:** `bosses-{mod}[-scraped].json`

**Required Fields:**

-   `id` (number) - Unique ID following range rules
-   `name` (string) - Boss display name
-   `mod` (string) - "vanilla" | "calamity" | "thorium"
-   `progression` (string) - "pre-hardmode" | "hardmode" | "post-moonlord"
-   `order` (number) - **CRITICAL:** Boss progression order for sorting loadouts

**Optional Fields:**

-   `health` (number) - Boss max HP (not scraped, rarely needed)
-   `defense` (number) - Boss defense stat (not scraped, rarely needed)

**Important:** The `order` field is essential for:

-   Sorting loadouts by boss progression in collections
-   Determining which boss comes first in game progression
-   UI display order in boss selection dropdowns

All scraped boss files now include the `order` field as of latest update.

### 4. Buffs/Potions

**Files:** `buffs-{mod}-js-puppeteer.json`

**Why Separate:** Buffs/potions are in JavaScript-collapsed wiki sections.

**Required Fields:**

-   `id` (number) - Unique ID following range rules
-   `name` (string) - Buff/potion name
-   `mod` (string) - "vanilla" | "calamity" | "thorium"
-   `type` (string) - "potion" or "consumable"
-   `rarity` (number) - Item rarity tier

**Optional Fields:**

-   `buff` (string) - Associated buff name

### 5. Ammunition

**Files:** `ammunition-{mod}[-scraped].json`

**Required Fields:**

-   `id` (number) - Unique ID following range rules
-   `name` (string) - Ammo name
-   `mod` (string) - "vanilla" | "calamity" | "thorium"
-   `type` (string) - "arrow" | "bullet" | "rocket" | etc.

**Optional Fields:**

-   `damage` (number) - Base ammo damage (not all ammo has fixed damage)
-   `rarity` (number) - Item rarity tier

## Data Generation & Scraping

There are three methods to generate item data:

### Method 1: Manual Generation (Legacy - Rarely Used)

Use the generator scripts for hand-picked, verified items:

```bash
pnpm generate-vanilla-items  # Generate vanilla items
pnpm generate-mod-items      # Generate Calamity & Thorium items
```

**Pros:**

-   Curated list of important items only
-   Verified stats and properties

**Cons:**

-   Time-consuming manual work
-   Incomplete coverage
-   Outdated approach

### Method 2: Cheerio Wiki Scraping (Static HTML)

Scrape weapons, armor, ammunition, and bosses from wiki pages:

```bash
pnpm scrape:all  # Scrape all three wikis
```

**What it scrapes:**

-   Weapons (swords, bows, guns, magic weapons, etc.)
-   Armor sets (helmets, chestplates, leggings)
-   Ammunition (arrows, bullets, rockets)
-   Bosses with progression order

**Output Files:**

-   `items-{mod}-scraped.json` (weapons + armor)
-   `ammo-{mod}-scraped.json` (ammunition)
-   `bosses-{mod}-scraped.json` (bosses with order field)

**Current Results:**

-   **Vanilla:** 417 weapons, 70 armor, 48 ammo, 18 bosses
-   **Calamity:** 774 weapons, 66 armor, 19 ammo, 26 bosses
-   **Thorium:** 56 weapons, 2 armor, 28 ammo, 11 bosses

**Pros:**

-   Fast execution (static HTML parsing)
-   Reliable extraction from HTML tables
-   No Cloudflare issues

**Cons:**

-   Cannot access JavaScript-collapsed sections
-   Misses accessories and buffs

### Method 3: Puppeteer Scraping (JavaScript-Rendered Content)

Scrape accessories and buffs/potions from collapsed wiki sections:

```bash
pnpm scrape:js  # Scrape JavaScript sections for all mods
```

**What it scrapes:**

-   Accessories (collapsed MediaWiki tables)
-   Buffs/Potions (collapsed MediaWiki tables)

**Output Files:**

-   `items-{mod}-accessories-js-puppeteer.json`
-   `buffs-{mod}-js-puppeteer.json`

**Current Results:**

-   **Calamity:** 217 accessories, 18 potions
-   **Thorium:** 264 accessories, 16 potions
-   **Vanilla:** 0 items (wiki structure incompatible with Puppeteer)

**Pros:**

-   Accesses JavaScript-rendered content
-   Cloudflare bypass with puppeteer-extra + stealth plugin
-   Comprehensive accessory coverage

**Cons:**

-   Slow (browser automation overhead)
-   Vanilla wiki incompatible (different JavaScript structure)
-   Requires headless Chrome/Chromium

### Recommended Workflow:

1. **Initial Data Collection:**

    ```bash
    pnpm scrape:all  # Get weapons, armor, ammo, bosses
    pnpm scrape:js   # Get accessories and buffs
    ```

2. **Review Generated Files:**

    - Check `-scraped` files for accuracy
    - Verify boss `order` field is present
    - Review accessories for armor pieces that shouldn't be included

3. **Merge to Production:**

    - Copy/rename `-scraped` files to remove suffix if data is good
    - Or selectively merge new items into existing files

4. **Periodic Updates:**
    - Re-run scrapers when mods update
    - Compare new scraped data with existing data
    - Merge in new items/bosses

## Technical Implementation

### Scraper Architecture:

**Base Scraper (`base-scraper.ts`):**

-   Provides `fetchPage()`, `loadHtml()`, parsing utilities
-   Inherited by all mod-specific scrapers

**Mod-Specific Scrapers:**

-   `vanilla-scraper.ts` - Official Terraria wiki
-   `calamity-scraper.ts` - Calamity Mod wiki
-   `thorium-scraper.ts` - Thorium Mod wiki

**Puppeteer Scraper:**

-   `puppeteer-universal-scraper.ts` - Universal scraper for all mods
-   Uses puppeteer-extra with stealth plugin
-   Clicks collapsed sections to reveal content

**Orchestration Scripts:**

-   `scrape-all-wikis.ts` - Runs all Cheerio scrapers
-   `scrape-js-sections.ts` - Runs Puppeteer for accessories/buffs

### Boss Order System:

The `order` field in boss data is **CRITICAL** for the application:

1. **Scrapers assign order:** Sequential numbering during scraping (order = index + 1)
2. **Boss utility (`lib/terraria/bosses.ts`):** Provides `getBossOrder(bossName)` function
3. **UI usage:** CollectionViewer sorts loadouts by boss progression using order field
4. **Progression groups:**
    - Pre-Hardmode bosses (order 1-8 for Vanilla)
    - Hardmode bosses (order 9-17 for Vanilla)
    - Post-Moonlord bosses (order 18+ for Vanilla)

**Old System (Deprecated):**

-   Hardcoded 47-boss array in CollectionViewer ❌
-   Required code changes to add new bosses ❌
-   Inconsistent between scraped and manual data ❌

**New System (Current):**

-   Boss order stored in JSON data ✅
-   `getBossOrder()` utility function ✅
-   Dynamically loads from all boss files ✅
-   Supports partial name matching ✅

## Data Loading Pattern

### In Code:

```typescript
// Load all items from all mods
import vanillaItems from "@/data/items-vanilla.json"
import calamityItems from "@/data/items-calamity.json"
import thoriumItems from "@/data/items-thorium.json"

// Load accessories separately
import calamityAccessories from "@/data/items-calamity-accessories-js-puppeteer.json"
import thoriumAccessories from "@/data/items-thorium-accessories-js-puppeteer.json"

const allItems = [...vanillaItems, ...calamityItems, ...thoriumItems]
const allAccessories = [...calamityAccessories, ...thoriumAccessories]

// Filter by mod
const calamityOnly = allItems.filter((item) => item.mod === "calamity")

// Use boss utility for ordering
import { getBossOrder, getAllBosses } from "@/lib/terraria/bosses"
const bossOrder = getBossOrder("Moon Lord") // Returns order number
const allBosses = getAllBosses() // Returns all bosses sorted by order
```

### Benefits:

1. **Modularity** - Easy to add/remove mods
2. **Clear Organization** - Files grouped by category, mod, and scraping method
3. **No ID Conflicts** - Each mod has its own ID range
4. **Comprehensive Data** - Automated scraping covers all wiki content
5. **Dynamic Boss Ordering** - No hardcoded boss lists in UI code

## Validation Checklist

Before merging scraped data into production:

-   [ ] All files follow `{category}-{mod}[-suffix].json` naming
-   [ ] All IDs are within correct range for their mod
-   [ ] No overlapping IDs between mods
-   [ ] Boss files include `order` field for each boss
-   [ ] Accessories don't include armor pieces (helmets, chest armor, leggings)
-   [ ] Potions don't include category headings or non-consumables
-   [ ] All required fields present for each category
-   [ ] `mod` field matches filename mod
-   [ ] Scraped data reviewed for quality (no malformed names, no duplicates)
-   [ ] Weapon `weaponClass` field matches mod classes (include "rogue" for Calamity, "healer"/"symphonic" for Thorium)

## Troubleshooting

### Issue: Ammo IDs don't start at mod's base ID

**This is expected behavior!** All item-type categories (items, ammo, accessories, potions) use continuous ID allocation to prevent conflicts:

**Calamity example:**

-   Items: 100,000-100,839 (840 items)
-   Ammo: 100,840-100,858 (19 ammo, continues from items)
-   Accessories: 100,859-101,075 (217 accessories, continues from ammo)
-   Potions: 101,076-101,093 (18 potions, continues from accessories)

This ensures that if you ever load items, ammo, accessories, and potions together, there are no ID conflicts. The scraper uses a single ID counter that increments across all categories.

If you need each category to start at the mod's base ID, you would need to modify the scraper to use separate ID counters for each category - but this could cause conflicts if you ever combine the data.

### Issue: Boss IDs overlap with item IDs

**This is technically okay** because bosses and items are stored in separate files and queried separately. However, if you're concerned about this:

**Current system:**

-   Vanilla bosses: 1-18 (overlaps with vanilla items 1-18)
-   Calamity bosses: 100,000-100,025 (overlaps with calamity items 100,000-100,025)

**Alternative approach (not currently implemented):**
Reserve sub-ranges within each mod:

-   Vanilla items: 1-49,999
-   Vanilla bosses: 50,000-50,999
-   Calamity items: 100,000-149,999
-   Calamity bosses: 150,000-150,999

If you want separate ID ranges for bosses, this would require modifying the scraper.

### Issue: Scraped files have 0 items

**Cause:** Wiki structure changed or Cloudflare blocked request
**Fix:** Check scraper error messages, verify wiki URLs still work, update selectors if needed

### Issue: Boss order missing in scraped data

**Cause:** Old scraper version
**Fix:** Re-run `pnpm scrape:all` with updated scraper (now includes order field)

### Issue: Accessories include armor pieces

**Cause:** Wiki pages list armor in accessory sections
**Fix:** Already filtered in current scrapers (armor type detection)

### Issue: Vanilla Puppeteer returns 0 items

**Cause:** Vanilla wiki uses different JavaScript collapse structure
**Fix:** Use Cheerio scraper for Vanilla weapons/armor, manually curate accessories if needed

---

**Remember:** Scraped data should be reviewed before replacing production files. The `-scraped` and `-js-puppeteer` suffixes indicate data that needs verification.
